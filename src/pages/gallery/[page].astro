---
import Layout from '../../layouts/Layout.astro';
import { getImagesInfo } from '../../utils/getImagesInfo';

export async function getStaticPaths() {
  const rootDirectory = Astro.root ?? process.cwd();
  const { totalPages } = getImagesInfo(rootDirectory);
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) }
  }));
}

/**
 * HELPER FUNCTION: Generates a smart pagination array.
 * e.g., getPaginationNumbers(5, 10) => [1, '...', 4, 5, 6, '...', 10]
 */
function getPaginationNumbers(currentPage, totalPages, siblings = 1) {
  if (totalPages <= 7) {
    // If 7 or fewer pages, show all numbers
    return Array.from({ length: totalPages }, (_, i) => i + 1);
  }

  const firstPage = 1;
  const lastPage = totalPages;

  // Pages to show: first, last, current, and siblings
  const pagesToShow = new Set([
    firstPage,
    lastPage,
    currentPage,
  ]);

  for (let i = 1; i <= siblings; i++) {
    if (currentPage - i > firstPage) {
      pagesToShow.add(currentPage - i);
    }
    if (currentPage + i < lastPage) {
      pagesToShow.add(currentPage + i);
    }
  }

  // Convert Set to sorted array
  const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);

  // Add ellipses where there are gaps
  const finalPages = [];
  let lastAddedPage = 0;

  for (const page of sortedPages) {
    if (lastAddedPage !== 0 && page - lastAddedPage > 1) {
      finalPages.push('...'); // Add ellipsis for the gap
    }
    finalPages.push(page);
    lastAddedPage = page;
  }

  return finalPages;
}

// (Your existing variables are here)
const rootDirectory = Astro.root ?? process.cwd();
const { files, perPage, totalPages } = getImagesInfo(rootDirectory);
const { page } = Astro.params;
const currentPage = parseInt(page, 10);
const start = (currentPage - 1) * perPage;
const images = files.slice(start, start + perPage);

// --- NEW VARIABLE ---
// Generate the list of pages to display
const paginationNumbers = getPaginationNumbers(currentPage, totalPages);
---

<Layout title={`Gallery - Page ${currentPage}`} activePage="gallery">
  <br>
  <br>
  <h1>My Photos - Page {currentPage}</h1>
  <p>Here are pictures I have enjoyed taking over the years to record my memories, experiences and travels.</p>
  <br>
  <br>
  <nav class="pagination">
    {currentPage > 1 && (
      <a href={`/gallery/${currentPage - 1}`}>&laquo; Previous</a>
    )}

    {paginationNumbers.map((pageNum) => {
      if (typeof pageNum === 'string') {
        // This is an ellipsis "..."
        return <span class="ellipsis">&hellip;</span>;
      }

      // This is a page number
      return (
        <a
          href={`/gallery/${pageNum}`}
          class={pageNum === currentPage ? 'active' : ''}
        >
          {pageNum}
        </a>
      );
    })}

    {currentPage < totalPages && (
      <a href={`/gallery/${currentPage + 1}`}>Next &raquo;</a>
    )}
  </nav>

  <div class="gallery-full">
    {images.map((image) => (
      <img src={`/images/${image}`} alt="Gallery image" loading="lazy" class="clickable" />
    ))}
  </div>
  
  <!-- Pagination Navigation -->
  <nav class="pagination">
    {currentPage > 1 && (
      <a href={`/gallery/${currentPage - 1}`}>&laquo; Previous</a>
    )}

    {paginationNumbers.map((pageNum) => {
      if (typeof pageNum === 'string') {
        // This is an ellipsis "..."
        return <span class="ellipsis">&hellip;</span>;
      }

      // This is a page number
      return (
        <a
          href={`/gallery/${pageNum}`}
          class={pageNum === currentPage ? 'active' : ''}
        >
          {pageNum}
        </a>
      );
    })}

    {currentPage < totalPages && (
      <a href={`/gallery/${currentPage + 1}`}>Next &raquo;</a>
    )}
  </nav>

  <!-- Modal for Enlarged Image -->
  <div id="modal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modal-img" alt="" src=""/>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("modal");
      const modalImg = document.getElementById("modal-img");
      const closeBtn = document.querySelector(".close");

      document.querySelectorAll('.gallery-full img.clickable').forEach(img => {
        img.addEventListener('click', () => {
          modal.style.display = "flex"; // Use flex to center the content
          modalImg.src = img.src;
        });
      });

      closeBtn.addEventListener('click', () => {
        modal.style.display = "none";
      });

      // Close modal when clicking outside the image
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });
    });
  </script>
</Layout>
